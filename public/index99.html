<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fyll NovaHub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root{
      --bg-900:#07040a; --panel:#0f1220; --accent:#A55EEA; --accent-2:#53E0C9; --muted:#9aa0a6;
    }
    body{min-height:100vh;background:radial-gradient(circle at 10% 10%, #071029 0%, #000 60%); color:#e7e7ea; font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(165,94,234,0.06); border-radius:12px; padding:1rem;}
    .btn { padding:.5rem .8rem; border-radius:10px; font-weight:600; cursor:pointer;}
    .btn-primary{ background:linear-gradient(90deg,var(--accent), #6b2be2); color:white; border:none}
    .btn-ghost{ background:transparent; color:var(--muted); border:1px solid rgba(255,255,255,0.03)}
    .small-muted{ font-size:.9rem; color:#b8b8bf }
    .hidden{ display:none; }
    .tab-active{ box-shadow: 0 6px 20px rgba(107,43,226,0.25);}
    textarea, input, select { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.04); color:inherit; padding:.6rem; border-radius:8px; width:100%;}
    .danger { color: #ff7a7a }
  </style>
</head>
<body class="p-6">

  <div class="max-w-6xl mx-auto">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-white/5 flex items-center justify-center"><img src="logo.png" alt="logo" class="w-10 h-10"></div>
        <div>
          <div class="text-2xl font-bold">Fyll <span style="color:var(--accent)">NovaHub</span></div>
          <div class="small-muted">Obfuscation · Storage · ALU</div>
        </div>
      </div>

      <div id="top-controls" class="flex items-center gap-3">
        <div id="presence-box" class="small-muted">Not signed in</div>
        <button id="btn-signin" class="btn btn-primary">Sign in with Discord</button>
        <button id="btn-logout" class="btn btn-ghost hidden">Sign out</button>
      </div>
    </header>

    <div class="grid grid-cols-12 gap-6">
      <aside class="col-span-12 lg:col-span-3 space-y-4">
        <div class="card">
          <nav class="space-y-2">
            <button class="w-full text-left p-2 rounded tab-btn tab-active" data-tab="home">Home</button>
            <button class="w-full text-left p-2 rounded tab-btn" data-tab="obfuscator">Obfuscator</button>
            <button class="w-full text-left p-2 rounded tab-btn" data-tab="loader">Script Loader</button>
            <button class="w-full text-left p-2 rounded tab-btn" data-tab="scripts">My Scripts</button>
            <button class="w-full text-left p-2 rounded tab-btn" data-tab="info">Info</button>
          </nav>
        </div>

        <div class="card">
          <h4 class="font-semibold">Discord Presence</h4>
          <div id="discord-presence" class="mt-3 small-muted">Sign in with Discord to populate presence.</div>
        </div>

        <div class="card">
          <h4 class="font-semibold">Notifications</h4>
          <div id="alerts" class="mt-3 small-muted">No alerts</div>
        </div>
      </aside>

      <main class="col-span-12 lg:col-span-9 space-y-6">
        <!-- HOME -->
        <section id="tab-home" class="tab-panel card">
          <h2 class="text-xl font-bold">Dashboard</h2>
          <p class="small-muted mt-2">Welcome to NovaHub. Use the left menu to switch tools.</p>

          <div class="grid grid-cols-2 gap-4 mt-4">
            <div class="p-4 bg-white/3 rounded">
              <div class="text-sm small-muted">Stored scripts</div>
              <div id="stat-scripts" class="text-2xl font-bold mt-2">—</div>
            </div>
            <div class="p-4 bg-white/3 rounded">
              <div class="text-sm small-muted">Recent accesses (ALU)</div>
              <div id="stat-alu" class="text-2xl font-bold mt-2">—</div>
            </div>
          </div>
        </section>

        <!-- OBFUSCATOR -->
        <section id="tab-obfuscator" class="tab-panel card hidden">
          <h2 class="text-xl font-bold">Obfuscator</h2>
          <div class="small-muted">Paste code or upload a .lua file, then Obfuscate or Store as loader.</div>

          <div class="mt-3">
            <div class="flex gap-2 items-center">
              <select id="preset" class="w-36">
                <option>Low</option><option selected>Medium</option><option>High</option>
              </select>
              <label class="btn btn-ghost cursor-pointer">
                <input id="file-upload" type="file" accept=".lua,.txt" class="hidden"> Upload
              </label>
              <button id="btn-obfuscate" class="btn btn-primary">Obfuscate</button>
              <button id="btn-store" class="btn btn-primary">Generate & Store (Loader)</button>
              <div id="obf-status" class="ml-auto small-muted">Ready</div>
            </div>

            <textarea id="lua-input" rows="12" class="mt-3" placeholder="Paste Lua code...">print("NovaHub Secure Script Initialized!")</textarea>
            <div class="mt-3 flex gap-2">
              <button id="btn-copy-output" class="btn btn-ghost">Copy Output</button>
              <div id="obf-output-small" class="ml-auto small-muted"></div>
            </div>
          </div>
        </section>

        <!-- LOADER -->
        <section id="tab-loader" class="tab-panel card hidden">
          <h2 class="text-xl font-bold">Script Loader</h2>
          <p class="small-muted">Your stored loader scripts. Click a script to edit, test, or delete.</p>

          <div class="mt-4">
            <div id="loader-list" class="space-y-3">
              <div class="small-muted">Loading your scripts...</div>
            </div>
          </div>
        </section>

        <!-- SCRIPTS -->
        <section id="tab-scripts" class="tab-panel card hidden">
          <h2 class="text-xl font-bold">My Scripts</h2>
          <p class="small-muted mt-2">View metadata and click to edit loader code or delete.</p>
          <div id="scripts-list" class="mt-3 space-y-3 small-muted">Loading...</div>
        </section>

        <!-- INFO -->
        <section id="tab-info" class="tab-panel card hidden">
          <h2 class="text-xl font-bold">Info</h2>
          <p class="small-muted mt-2">Guide and suspicious activity notifications.</p>

          <div class="mt-4">
            <div class="small-muted">If loader retrieval attempts happen outside Roblox, they'll be flagged as suspicious in notifications & activity tab.</div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <!-- Edit modal -->
  <div id="edit-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative w-11/12 md:w-2/3 lg:w-1/2 p-4 card z-60">
      <div class="flex items-center justify-between mb-3">
        <div class="font-bold">Edit Script Loader</div>
        <button id="edit-close" class="btn btn-ghost">Close</button>
      </div>
      <div>
        <div class="small-muted mb-2">Script key: <span id="edit-key"></span></div>
        <textarea id="edit-script" rows="12"></textarea>
        <div class="mt-3 flex gap-2">
          <button id="edit-save" class="btn btn-primary">Save (overwrite)</button>
          <button id="edit-delete" class="btn btn-ghost">Delete</button>
          <button id="edit-copy" class="btn btn-ghost">Copy Loader</button>
          <div id="edit-msg" class="ml-auto small-muted"></div>
        </div>
      </div>
    </div>
  </div>

<script>
const API_ROOT = 'https://novahub-zd14.onrender.com'; // leave blank if frontend served from same origin

// utils
const $ = (sel)=>document.querySelector(sel);
const $all = (sel)=>Array.from(document.querySelectorAll(sel));
function setSmall(id,txt){ const el=$(id); if(el) el.textContent = txt; }

// auth tokens
function storeTokens(access, refresh){
  localStorage.setItem('fy_access', access);
  localStorage.setItem('fy_refresh', refresh);
}
function clearTokens(){ localStorage.removeItem('fy_access'); localStorage.removeItem('fy_refresh'); }
function getAccess(){ return localStorage.getItem('fy_access'); }

async function apiFetch(path, opts={}){
  opts.headers = opts.headers || {};
  if (getAccess()) opts.headers['Authorization'] = 'Bearer ' + getAccess();
  const res = await fetch((API_ROOT||'') + path, opts);
  if (res.status === 401) {
    // try refresh
    const refreshed = await refreshTokens();
    if (refreshed) {
      opts.headers['Authorization'] = 'Bearer ' + getAccess();
      return fetch((API_ROOT||'') + path, opts);
    }
  }
  return res;
}
async function refreshTokens(){
  const refresh = localStorage.getItem('fy_refresh');
  if (!refresh) return false;
  try {
    const res = await fetch((API_ROOT||'') + '/auth/refresh', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ refreshToken: refresh })
    });
    if (!res.ok) { clearTokens(); updateUiSignedOut(); return false;}
    const j = await res.json();
    storeTokens(j.accessToken, j.refreshToken);
    return true;
  } catch(e){ clearTokens(); updateUiSignedOut(); return false; }
}

// UI: tabs
$all('.tab-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $all('.tab-btn').forEach(b=>b.classList.remove('tab-active'));
    btn.classList.add('tab-active');
    const tab = btn.dataset.tab;
    $all('.tab-panel').forEach(p=>p.classList.add('hidden'));
    document.getElementById('tab-'+tab).classList.remove('hidden');
    if (tab === 'scripts' || tab === 'loader') loadScripts();
    if (tab === 'home') loadStats();
  });
});

// auth flow: Discord popup
$('#btn-signin').addEventListener('click', ()=>{
  const w = window.open((API_ROOT||'') + '/auth/discord', '_blank', 'width=600,height=800');
  // popup returns tokens via postMessage
});

// receive OAuth tokens from popup
window.addEventListener('message', (ev)=>{
  try {
    const data = ev.data;
    if (data && data.accessToken) {
      storeTokens(data.accessToken, data.refreshToken);
      updateUiSignedIn();
      setSmall('#obf-status', 'Signed in via Discord');
      fetchPresence();
    }
  } catch(e){}
});

// logout
$('#btn-logout').addEventListener('click', async ()=>{
  const refresh = localStorage.getItem('fy_refresh');
  try { await fetch((API_ROOT||'') + '/auth/logout', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ refreshToken: refresh }) }); } catch (e){}
  clearTokens();
  updateUiSignedOut();
});

// update UI when signed in
async function updateUiSignedIn(){
  const me = await getMe();
  if (!me) return updateUiSignedOut();
  $('#btn-signin').classList.add('hidden');
  $('#btn-logout').classList.remove('hidden');
  $('#presence-box').textContent = me.username || me.email || 'Account';
  $('#discord-presence').innerHTML = `<div class="flex items-center gap-2"><img src="${discordAvatarUrl(me.discord_id, me.discord_avatar)}" class="w-10 h-10 rounded" onerror="this.style.display='none'"> <div><div class="font-semibold">${me.username||me.email}</div><div class="small-muted">Role: ${me.role||'user'}</div></div></div>`;
  loadScripts();
  loadActivity();
  loadStats();
}
function updateUiSignedOut(){
  $('#btn-signin').classList.remove('hidden');
  $('#btn-logout').classList.add('hidden');
  $('#presence-box').textContent = 'Not signed in';
  $('#discord-presence').textContent = 'Sign in with Discord to populate presence.';
  $('#scripts-list').innerHTML = '<div class="small-muted">Sign in to see your stored scripts.</div>';
  $('#loader-list').innerHTML = '<div class="small-muted">Sign in to manage loaders.</div>';
  setSmall('#stat-scripts','—'); setSmall('#stat-alu','—');
}

// helper: discord avatar url
function discordAvatarUrl(id, avatar){
  if (!id || !avatar) return '';
  return `https://cdn.discordapp.com/avatars/${id}/${avatar}.png`;
}

// get current user
async function getMe(){
  const access = getAccess(); if (!access) return null;
  try {
    const res = await apiFetch('/auth/me');
    if (!res.ok) { clearTokens(); updateUiSignedOut(); return null; }
    return await res.json();
  } catch (e) { return null; }
}

// Obfuscator handlers
$('#file-upload').addEventListener('change', (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const r = new FileReader(); r.onload = ()=> $('#lua-input').value = r.result; r.readAsText(f);
});
$('#btn-obfuscate').addEventListener('click', async ()=>{
  const code = $('#lua-input').value;
  if (!code.trim()) return setSmall('#obf-status','Paste Lua code first');
  setSmall('#obf-status','Obfuscating...');
  const res = await apiFetch('/obfuscate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ code, preset: $('#preset').value }) });
  const j = await res.json();
  if (!res.ok) return setSmall('#obf-status', 'Failed: ' + (j.error||'server error'));
  // show obfuscated in output
  $('#obf-output-small').textContent = (j.obfuscatedCode||'') .slice(0,200) + ( (j.obfuscatedCode && j.obfuscatedCode.length>200) ? '...' : '' );
  setSmall('#obf-status','Obfuscation complete');
});
$('#btn-store').addEventListener('click', async ()=>{
  const script = $('#lua-input').value;
  if (!script.trim()) return setSmall('#obf-status','Paste Lua code first');
  setSmall('#obf-status','Storing script...');
  const res = await apiFetch('/obfuscate-and-store', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ script, preset: $('#preset').value }) });
  const j = await res.json();
  if (!res.ok) return setSmall('#obf-status', 'Store failed: ' + (j.error||'server error'));
  setSmall('#obf-status','Stored ✓ Key: ' + j.key);
  loadScripts();
});

// load scripts (for both scripts tab and loader tab)
async function loadScripts(){
  const res = await apiFetch('/api/scripts');
  if (!res.ok) { $('#scripts-list').innerHTML = '<div class="small-muted">No scripts or not signed in.</div>'; $('#loader-list').innerHTML = '<div class="small-muted">No scripts or not signed in.</div>'; return; }
  const arr = await res.json();
  $('#scripts-list').innerHTML = '';
  $('#loader-list').innerHTML = '';
  if (!arr.length) {
    $('#scripts-list').innerHTML = '<div class="small-muted">No stored scripts yet.</div>';
    $('#loader-list').innerHTML = '<div class="small-muted">No stored scripts yet.</div>';
    setSmall('#stat-scripts','0');
    return;
  }
  setSmall('#stat-scripts', arr.length.toString());
  for (const s of arr) {
    // scripts list item
    const el = document.createElement('div'); el.className='p-3 bg-white/5 rounded flex items-center justify-between';
    el.innerHTML = `<div><div class="font-semibold">${s.title || s.key}</div><div class="small-muted">Uses: ${s.uses || 0} · Created: ${new Date(s.created_at).toLocaleString()}</div></div>`;
    const right = document.createElement('div'); right.className='flex gap-2';
    const editBtn = document.createElement('button'); editBtn.className='btn btn-ghost'; editBtn.textContent='Edit';
    editBtn.addEventListener('click', ()=> openEdit(s.key));
    const loaderBtn = document.createElement('button'); loaderBtn.className='btn btn-primary'; loaderBtn.textContent='Get Loader';
    loaderBtn.addEventListener('click', ()=> {
      const url = (API_ROOT||'') + '/retrieve/' + s.key;
      $('#obf-output-small').textContent = `loadstring(game:HttpGet("${url}"))()`;
      setSmall('#obf-status','Loader ready');
    });
    const delBtn = document.createElement('button'); delBtn.className='btn btn-ghost'; delBtn.textContent='Delete';
    delBtn.addEventListener('click', async ()=> {
      if (!confirm('Delete script?')) return;
      const dres = await apiFetch('/api/scripts/' + s.key, { method:'DELETE' });
      if (!dres.ok) { alert('Delete failed'); return; }
      loadScripts();
    });
    right.appendChild(loaderBtn); right.appendChild(editBtn); right.appendChild(delBtn);
    el.appendChild(right);
    $('#scripts-list').appendChild(el);

    // loader list for loader tab
    const le = document.createElement('div'); le.className='p-3 bg-white/5 rounded flex items-center justify-between';
    le.innerHTML = `<div><div class="font-semibold">${s.title || s.key}</div><div class="small-muted">Uses: ${s.uses || 0}</div></div>`;
    const lright = document.createElement('div'); lright.className='flex gap-2';
    const ledit = document.createElement('button'); ledit.className='btn btn-ghost'; ledit.textContent='Edit'; ledit.addEventListener('click', ()=> openEdit(s.key));
    const lcopy = document.createElement('button'); lcopy.className='btn btn-primary'; lcopy.textContent='Copy Loader';
    lcopy.addEventListener('click', ()=> { navigator.clipboard.writeText(`loadstring(game:HttpGet("${(API_ROOT||'') + '/retrieve/' + s.key}"))()`); setSmall('#obf-status','Copied loader'); });
    lright.appendChild(lcopy); lright.appendChild(ledit);
    le.appendChild(lright);
    $('#loader-list').appendChild(le);
  }
}

// open edit modal: fetch full script, place in textarea
async function openEdit(key){
  const res = await apiFetch('/api/scripts/' + key);
  if (!res.ok) { alert('Failed to load script'); return; }
  const j = await res.json();
  $('#edit-key').textContent = j.key;
  $('#edit-script').value = j.script || '';
  $('#edit-modal').classList.remove('hidden');
}
$('#edit-close').addEventListener('click', ()=> $('#edit-modal').classList.add('hidden'));
$('#edit-copy').addEventListener('click', ()=> {
  navigator.clipboard.writeText($('#edit-script').value || '').then(()=> $('#edit-msg').textContent = 'Copied');
});
$('#edit-delete').addEventListener('click', async ()=> {
  if (!confirm('Delete script?')) return;
  const key = $('#edit-key').textContent;
  const res = await apiFetch('/api/scripts/' + key, { method:'DELETE' });
  if (!res.ok) { $('#edit-msg').textContent = 'Delete failed'; return; }
  $('#edit-msg').textContent = 'Deleted';
  $('#edit-modal').classList.add('hidden');
  loadScripts();
});
$('#edit-save').addEventListener('click', async ()=>{
  // For safety we implement save by re-uploading via obfuscate-and-store replacement pattern:
  // Simpler: no direct update endpoint in server (to keep DB logic simple). We'll delete and re-insert.
  const key = $('#edit-key').textContent;
  const scriptText = $('#edit-script').value || '';
  if (!scriptText) return $('#edit-msg').textContent = 'Script empty';
  // Delete existing
  const del = await apiFetch('/api/scripts/' + key, { method:'DELETE' });
  if (!del.ok) { $('#edit-msg').textContent = 'Failed to delete old entry'; return; }
  // Store new script (obfuscate-and-store) with same title blank
  const store = await apiFetch('/obfuscate-and-store', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ script: scriptText, preset: 'Medium' }) });
  if (!store.ok) { const j = await store.json(); $('#edit-msg').textContent = 'Store failed: ' + (j.error||'server error'); return; }
  const j = await store.json();
  $('#edit-msg').textContent = 'Saved new key: ' + j.key;
  $('#edit-modal').classList.add('hidden');
  loadScripts();
});

// activity / suspicious detection
async function loadActivity(){
  const res = await apiFetch('/api/user/activity');
  if (!res.ok) { setSmall('#alerts','No activity'); return; }
  const rows = await res.json();
  const suspicious = rows.filter(r => r.event_type === 'retrieve_blocked_non_roblox' || r.event_type === 'retrieve_not_found');
  if (suspicious.length) {
    $('#alerts').innerHTML = `<div class="danger font-semibold">Suspicious activity detected (${suspicious.length})</div><div class="small-muted">${suspicious.slice(0,5).map(s=>`${new Date(s.created_at).toLocaleString()} · ${s.event_type} · key=${s.script_key||'-'}`).join('<br>')}</div>`;
  } else {
    $('#alerts').innerHTML = '<div class="small-muted">No suspicious activity</div>';
  }
  setSmall('#stat-alu', rows.length.toString());
}

// fetch presence (display avatar)
async function fetchPresence(){
  const me = await getMe();
  if (!me) return;
  if (me.discord_id) {
    $('#discord-presence').innerHTML = `<div class="flex items-center gap-2"><img src="https://cdn.discordapp.com/avatars/${me.discord_id}/${me.discord_avatar}.png" class="w-12 h-12 rounded" onerror="this.style.display='none'"> <div><div class="font-semibold">${me.username || me.email}</div><div class="small-muted">Discord ID: ${me.discord_id}</div></div></div>`;
  }
}

// load dashboard stats
async function loadStats(){
  const scriptsRes = await apiFetch('/api/scripts');
  if (!scriptsRes.ok) { setSmall('#stat-scripts','—'); return; }
  const arr = await scriptsRes.json();
  setSmall('#stat-scripts', String(arr.length));
  const actRes = await apiFetch('/api/user/activity');
  if (actRes.ok) { const r = await actRes.json(); setSmall('#stat-alu', String(r.length)); }
}

// on load
(async function init(){
  if (getAccess()) {
    await updateUiSignedIn();
  } else updateUiSignedOut();
})();
</script>

</body>
  </html>
